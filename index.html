// A-Frame + WebXR Meta Quest FPS Game
// Simple game with a disk target, dot crosshair, unlimited ammo, and hit marker

<html>
  <head>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  </head>
  <body>
    <a-scene vr-mode-ui="enabled: true" embedded>

      <!-- Camera with gun script -->
      <a-entity id="cameraRig" position="0 1.6 0">
        <a-camera wasd-controls-enabled="false" look-controls="pointerLockEnabled: true">
          <a-entity 
            id="crosshair"
            geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
            material="color: red; shader: flat"
            position="0 0 -1"
          ></a-entity>
        </a-camera>
      </a-entity>

      <!-- Target (disk with concentric rings) -->
      <a-entity id="target" position="0 1.6 -5">
        <a-circle radius="0.5" rotation="0 0 0" color="#FFFFFF"></a-circle>
        <a-ring radius-inner="0.1" radius-outer="0.2" rotation="0 0 0" color="#FF0000"></a-ring>
        <a-ring radius-inner="0.2" radius-outer="0.3" rotation="0 0 0" color="#FF9900"></a-ring>
        <a-ring radius-inner="0.3" radius-outer="0.4" rotation="0 0 0" color="#FFFF00"></a-ring>
        <a-ring radius-inner="0.4" radius-outer="0.5" rotation="0 0 0" color="#00FF00"></a-ring>
      </a-entity>

      <!-- Ground and background -->
      <a-plane rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>

      <!-- Gun logic -->
      <a-entity id="gun-handler" gun-shoot></a-entity>

      <script>
        AFRAME.registerComponent('gun-shoot', {
          init: function () {
            this.isAiming = false;
            this.el.sceneEl.addEventListener('triggerdown', () => {
              this.isAiming = true;
            });
            this.el.sceneEl.addEventListener('triggerup', () => {
              if (this.isAiming) {
                this.shoot();
              }
              this.isAiming = false;
            });
          },

          shoot: function () {
            const camera = document.querySelector('[camera]');
            const direction = new THREE.Vector3();
            camera.object3D.getWorldDirection(direction);

            const origin = new THREE.Vector3();
            camera.object3D.getWorldPosition(origin);

            const raycaster = new THREE.Raycaster(origin, direction);
            const targetObj = document.querySelector('#target');
            const intersects = raycaster.intersectObject(targetObj.object3D, true);

            if (intersects.length > 0) {
              console.log('Hit!');
              const hitPoint = intersects[0].point;
              this.spawnHitMarker(hitPoint);
            } else {
              console.log('Miss');
            }
          },

          spawnHitMarker: function (position) {
            const scene = document.querySelector('a-scene');
            const marker = document.createElement('a-sphere');
            marker.setAttribute('radius', '0.01');
            marker.setAttribute('color', 'black');
            marker.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
            scene.appendChild(marker);

            // Remove marker after 1.5 seconds
            setTimeout(() => {
              scene.removeChild(marker);
            }, 1500);
          }
        });
      </script>

    </a-scene>
  </body>
</html>
